GTK = gtk+-3.0
GTK_CFLAGS := $(shell pkg-config --cflags ${GTK})
GTK_LIBS := $(shell pkg-config --libs ${GTK})

LUAJIT_VER = LuaJIT-2.0.0-beta9
LUAJIT = deps/$(LUAJIT_VER)
LUAJIT_CFLAGS = -I$(LUAJIT)/src
LUAJIT_ARCHIVE = $(LUAJIT)/src/libluajit.a
LUAJIT_URL = http://luajit.org/download/$(LUAJIT_VER).tar.gz

SCINTILLA_VER = scintilla304
SCINTILLA_URL = http://prdownloads.sourceforge.net/scintilla/$(SCINTILLA_VER).tgz?download
SCINTILLA = deps/$(SCINTILLA_VER)
SCINTILLA_IFACE = $(SCINTILLA)/include/Scintilla.iface
SCINTILLA_CFLAGS = -I$(SCINTILLA)/include -DGTK=1
SCINTILLA_ARCHIVE = $(SCINTILLA)/bin/scintilla.a
SCINTILLA_DEFS = GTK=1 GTK3=1 LEXOBJS=

LPEG_VER = lpeg-0.10.2
LPEG = deps/$(LPEG_VER)
LPEG_OBJECT = $(LPEG)/lpeg.o
LPEG_URL = http://www.inf.puc-rio.br/~roberto/lpeg/$(LPEG_VER).tar.gz

SCINTILLUA_VER = scintillua3.0.4-1
SCINTILLUA = deps/$(SCINTILLUA_VER)
SCINTILLUA_SRC = $(SCINTILLUA)/LexLPeg.cxx
SCINTILLUA_LEXER = $(SCINTILLUA)/LexLPeg.o
SCINTILLUA_URL = http://foicica.com/scintillua/download/$(SCINTILLUA_VER).zip

LFS_VER = luafilesystem-1.5.0
LFS_URL = https://github.com/downloads/keplerproject/luafilesystem/$(LFS_VER).tar.gz
LFS = deps/$(LFS_VER)
LFS_OBJECT = deps/$(LFS_VER)/src/lfs.o

SCI_GEN = tools/sci_gen.lua
SCI_GEN_TARGET = ../lib/vilu/core/scintilla.lua

CFLAGS = -Wall -O2 $(LUAJIT_CFLAGS) $(SCINTILLA_CFLAGS) $(GTK_CFLAGS)
ARCHIVES = $(LUAJIT_ARCHIVE) $(SCINTILLA_ARCHIVE)
LIBS = -lm -ldl ${GTK_LIBS} -lstdc++
LD_FLAGS = -Wl,-E
OBJECTS = gtk_ui.o main.o
DEP_OBJECTS = $(LPEG)/lpeg.o $(SCINTILLUA_LEXER) $(LFS_OBJECT)

vilu: ${OBJECTS} vilu.h $(DEP_OBJECTS) $(ARCHIVES)
	  ${CC} -o vilu ${CFLAGS} ${OBJECTS} $(DEP_OBJECTS) ${ARCHIVES} ${LIBS} ${LD_FLAGS}

${OBJECTS}: %.o : %.c vilu.h
	  ${CC} -c $< ${CFLAGS}

$(LPEG):
	  wget -q -O - $(LPEG_URL) | tar xzf - -C deps

$(LPEG_OBJECT): $(LPEG) $(LUAJIT)
	  cd ${LPEG} && $(MAKE) lpeg.o LUADIR=../../$(LUAJIT)/src

$(SCINTILLA):
	  wget -q -O - $(SCINTILLA_URL) | tar xzf - -C deps
	  mv deps/scintilla $(SCINTILLA)
	  perl -piorig -e 's/LINK_LEXER\(\w+\);//' $(SCINTILLA)/src/Catalogue.cxx
	  perl -pi -e 's|//--Autogenerated.*|LINK_LEXER(lmLPeg);|' $(SCINTILLA)/src/Catalogue.cxx

$(SCINTILLA_ARCHIVE): $(SCINTILLA)
	  cd ${SCINTILLA}/gtk && make $(SCINTILLA_DEFS)

$(SCINTILLUA):
	  wget -q -O $(SCINTILLUA).zip $(SCINTILLUA_URL)
	  unzip -q $(SCINTILLUA).zip -d deps
	  rm -f $(SCINTILLUA).zip

$(SCINTILLUA_LEXER): $(SCINTILLUA) $(SCINTILLA)
	  g++ $(SCINTILLA_CFLAGS) $(LUAJIT_CFLAGS) -DLPEG_LEXER -I$(SCINTILLA)/lexlib -c $(SCINTILLUA_SRC) -o $(SCINTILLUA_LEXER)

$(LUAJIT):
	  wget -q -O - $(LUAJIT_URL) | tar xzf - -C deps

$(LUAJIT_ARCHIVE): $(LUAJIT)
	  cd ${LUAJIT} && make

$(LFS):
	  wget -q -O - $(LFS_URL) | tar xzf - -C deps

$(LFS_OBJECT): $(LFS)
	  cd ${LFS} && make LUA_INC=../../$(LUAJIT)/src

deps: scintilla-build luajit-build lpeg-build scintillua-build $(LFS_OBJECT)

clean:
	  -rm -f ${OBJECTS}

scigen: luajit-build
	  $(LUAJIT)/src/luajit $(SCI_GEN) $(SCINTILLA_IFACE) $(SCI_GEN_TARGET)
